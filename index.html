<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Statistics Merger (Date Sorted)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <style>
        .drop-zone { transition: all 0.3s ease; }
        .drop-zone.drag-over { background-color: #eff6ff; border-color: #3b82f6; transform: scale(1.02); }
        .file-list-item { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans text-gray-700">

    <div class="max-w-4xl mx-auto p-8">
        <div class="text-center mb-10">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ“Š í†µê³„ ì—‘ì…€ ë³‘í•©ê¸° (ë‚ ì§œ ì •ë ¬)</h1>
            <p class="text-gray-500">ì†ì ˆì¼ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-8">
            <div id="drop-zone" class="drop-zone border-2 border-dashed border-gray-300 rounded-xl p-10 text-center cursor-pointer hover:bg-gray-50 relative">
                <input type="file" id="file-input" multiple accept=".csv,.xlsx,.xls" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                <div class="flex flex-col items-center pointer-events-none">
                    <svg class="w-16 h-16 text-blue-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <h3 class="text-lg font-semibold text-gray-700">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</h3>
                    <p class="text-sm text-gray-400 mt-2">.xlsx, .csv íŒŒì¼ ì§€ì›</p>
                </div>
            </div>

            <div id="file-list-container" class="mt-8 hidden">
                <h4 class="text-sm font-semibold text-gray-600 mb-3 flex justify-between items-center">
                    <span>ì„ íƒëœ íŒŒì¼ (<span id="file-count">0</span>ê°œ)</span>
                    <button onclick="clearFiles()" class="text-xs text-red-500 hover:text-red-700 underline">ì´ˆê¸°í™”</button>
                </h4>
                <div id="file-list" class="space-y-2 max-h-60 overflow-y-auto pr-2"></div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-100 flex justify-end">
                <button id="process-btn" onclick="processFiles()" disabled class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg font-semibold shadow-md transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center">
                    <span id="btn-text">ìš”ì•½ íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ</span>
                    <svg id="loading-spinner" class="animate-spin ml-2 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </div>
        </div>
        <p class="text-center text-xs text-gray-400 mt-6">&copy; 2025 Trading Tool. Processed locally.</p>
    </div>

    <script>
        let selectedFiles = [];
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const fileListContainer = document.getElementById('file-list-container');
        const fileList = document.getElementById('file-list');
        const fileCountSpan = document.getElementById('file-count');
        const processBtn = document.getElementById('process-btn');
        const btnText = document.getElementById('btn-text');
        const loadingSpinner = document.getElementById('loading-spinner');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', () => { dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('drag-over'); handleFiles(e.dataTransfer.files); });
        fileInput.addEventListener('change', (e) => { handleFiles(e.target.files); });

        function handleFiles(files) {
            if (!files.length) return;
            selectedFiles = [...selectedFiles, ...Array.from(files)];
            updateFileList();
        }

        function clearFiles() {
            selectedFiles = [];
            fileInput.value = '';
            updateFileList();
        }

        function updateFileList() {
            fileList.innerHTML = '';
            fileCountSpan.textContent = selectedFiles.length;
            if (selectedFiles.length > 0) {
                fileListContainer.classList.remove('hidden');
                processBtn.disabled = false;
                selectedFiles.forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'file-list-item flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200';
                    div.innerHTML = `<span class="text-sm font-medium text-gray-700 truncate">${file.name}</span><span class="text-xs text-gray-400 whitespace-nowrap">${(file.size/1024).toFixed(1)} KB</span>`;
                    fileList.appendChild(div);
                });
            } else {
                fileListContainer.classList.add('hidden');
                processBtn.disabled = true;
            }
        }

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(file, 'UTF-8');
            });
        }

        async function processFiles() {
            if (selectedFiles.length === 0) return;
            processBtn.disabled = true;
            btnText.textContent = "ì²˜ë¦¬ ì¤‘...";
            loadingSpinner.classList.remove('hidden');

            try {
                const workbook = new ExcelJS.Workbook();
                const summarySheet = workbook.addWorksheet('ì†ì ˆìš”ì•½ì‹œíŠ¸');
                
                // ê¸°ë³¸ ì»¬ëŸ¼ ì„¤ì • (A: ì´ë¦„, B: íšŸìˆ˜, C: ê³µë°±)
                summarySheet.columns = [
                    { header: 'Group Name', key: 'name', width: 30 },
                    { header: 'ì†ì ˆíšŸìˆ˜', key: 'lossCount', width: 15 },
                    { header: '', key: 'spacer', width: 2 } // Cì—´ì€ ê³µë°±
                ];

                // ì¤‘ë³µ ë³‘í•©ì„ ìœ„í•œ Map: Key=GroupName, Value={ count: number, dates: string[] }
                let summaryMap = new Map();

                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    let rows = [];

                    if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                        const buffer = await readFileAsArrayBuffer(file);
                        const tempWorkbook = new ExcelJS.Workbook();
                        await tempWorkbook.xlsx.load(buffer);
                        const firstSheet = tempWorkbook.worksheets[0];
                        if (firstSheet) {
                            firstSheet.eachRow({ includeEmpty: false }, (row, rowNumber) => {
                                const rowValues = [];
                                row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                                    rowValues[colNumber - 1] = cell.value;
                                });
                                rows.push(rowValues);
                            });
                        }
                    } else {
                        const text = await readFileAsText(file);
                        const parsed = Papa.parse(text, { skipEmptyLines: 'greedy' });
                        rows = parsed.data;
                    }

                    // --- ë°ì´í„° ì¶”ì¶œ ---
                    let dataStartIndex = -1;
                    let headerRowIndex = -1;
                    let nameColIdx = 0;
                    let lossColIdx = -1;
                    let endDateColIdx = -1;

                    // í—¤ë” ì°¾ê¸°
                    for (let r = 0; r < rows.length; r++) {
                        const row = rows[r];
                        for(let c = 0; c < row.length; c++) {
                            const cellVal = String(row[c] || "").trim();
                            if (cellVal === "Group Name") {
                                headerRowIndex = r;
                                nameColIdx = c;
                                // ê°™ì€ ì¤„ì—ì„œ "ì†ì ˆíšŸìˆ˜"ì™€ "ì¢…ë£Œì¼" ì°¾ê¸°
                                for(let k = 0; k < row.length; k++) {
                                    const headerVal = String(row[k] || "").trim();
                                    if (headerVal === "ì†ì ˆíšŸìˆ˜") lossColIdx = k;
                                    if (headerVal === "ì¢…ë£Œì¼") endDateColIdx = k;
                                }
                                break;
                            }
                        }
                        if (headerRowIndex !== -1) break;
                    }

                    if (headerRowIndex !== -1 && lossColIdx !== -1) {
                        dataStartIndex = headerRowIndex + 1;
                        for (let r = dataStartIndex; r < rows.length; r++) {
                            const row = rows[r];
                            if (!row) continue;
                            
                            const rawName = row[nameColIdx];
                            const rawLoss = row[lossColIdx];
                            const rawDate = endDateColIdx !== -1 ? row[endDateColIdx] : "";

                            if (rawName) {
                                let nameStr = String(rawName).trim();
                                let lossVal = 0;

                                if (typeof rawLoss === 'object' && rawLoss !== null) {
                                     lossVal = rawLoss.result || rawLoss.text || 0;
                                } else {
                                     lossVal = parseInt(rawLoss) || 0;
                                }

                                if (nameStr) {
                                    if (!summaryMap.has(nameStr)) {
                                        summaryMap.set(nameStr, { count: 0, dates: [], type: '' });
                                    }
                                    
                                    const entry = summaryMap.get(nameStr);
                                    entry.count += lossVal;
                                    entry.type = nameStr.includes('-') ? 'minus' : (nameStr.includes('+') ? 'plus' : 'other');

                                    // ì†ì ˆì´ ë°œìƒí•œ í–‰(row)ì´ë¼ë©´ ë‚ ì§œ ì¶”ê°€
                                    if (lossVal > 0 && rawDate) {
                                        let dateStr = String(rawDate).trim();
                                        // ì—‘ì…€ ë‚ ì§œ ê°ì²´ ì²˜ë¦¬ (í•„ìš”ì‹œ)
                                        if (typeof rawDate === 'object' && rawDate instanceof Date) {
                                            dateStr = rawDate.toISOString().split('T')[0];
                                        }
                                        entry.dates.push(dateStr);
                                    }
                                }
                            }
                        }
                    }
                }

                // --- ìš”ì•½ ë°ì´í„° ì •ì œ, ë‚ ì§œ ì •ë ¬ ë° ë¶„ë¥˜ ---
                let allSummaryData = [];
                let maxDatesCount = 0;

                summaryMap.forEach((data, name) => {
                    if (data.count > 0) { // 0ì¸ ê²ƒ ì œì™¸
                        // *** ë‚ ì§œ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ (ë¹ ë¥¸ ë‚ ì§œ -> ëŠë¦° ë‚ ì§œ) ***
                        data.dates.sort();

                        if (data.dates.length > maxDatesCount) maxDatesCount = data.dates.length;
                        allSummaryData.push({
                            name: name,
                            count: data.count,
                            dates: data.dates,
                            type: data.type
                        });
                    }
                });

                // ë¶„ë¥˜ ë° ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ (ì†ì ˆ íšŸìˆ˜ ê¸°ì¤€)
                const minusGroup = allSummaryData.filter(d => d.type === 'minus').sort((a, b) => b.count - a.count);
                const plusGroup = allSummaryData.filter(d => d.type === 'plus').sort((a, b) => b.count - a.count);
                const otherGroup = allSummaryData.filter(d => d.type === 'other').sort((a, b) => b.count - a.count);

                // --- í—¤ë”ì— ë‚ ì§œ ì»¬ëŸ¼ ì¶”ê°€ (Dì—´ ë¶€í„°) ---
                for(let i=0; i<maxDatesCount; i++) {
                    summarySheet.getColumn(4 + i).width = 15; // Dì—´ë¶€í„° ë„ˆë¹„ 15 ì„¤ì •
                    summarySheet.getCell(1, 4 + i).value = `ì†ì ˆì¼ ${i+1}`;
                    summarySheet.getCell(1, 4 + i).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEFEFEF' } };
                    summarySheet.getCell(1, 4 + i).font = { bold: true };
                    summarySheet.getCell(1, 4 + i).alignment = { horizontal: 'center' };
                    summarySheet.getCell(1, 4 + i).border = { bottom: {style:'thin'} };
                }

                // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš© (A, B)
                const headerRow = summarySheet.getRow(1);
                headerRow.getCell(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEFEFEF' } }; // A
                headerRow.getCell(2).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEFEFEF' } }; // B
                headerRow.font = { bold: true };
                headerRow.alignment = { horizontal: 'center' };


                // --- ë°ì´í„° ì“°ê¸° í•¨ìˆ˜ ---
                const writeGroup = (groupData, colorCode) => {
                    groupData.forEach(d => {
                        // [Name, Count, Empty, Date1, Date2, ...]
                        const rowData = [d.name, d.count, '', ...d.dates];
                        const newRow = summarySheet.addRow(rowData);
                        
                        // ì´ë¦„ ì—´ ìƒ‰ìƒ
                        newRow.getCell(1).font = { color: { argb: colorCode } };
                    });
                };

                // ê·¸ë£¹ë³„ ì“°ê¸°
                let currentRowIdx = 2; // 1ì€ í—¤ë”
                const minusStart = currentRowIdx;
                writeGroup(minusGroup, 'FFCC0000'); // Red Text
                const minusEnd = currentRowIdx + minusGroup.length - 1;
                currentRowIdx += minusGroup.length;

                const plusStart = currentRowIdx;
                writeGroup(plusGroup, 'FF006600'); // Green Text
                const plusEnd = currentRowIdx + plusGroup.length - 1;
                currentRowIdx += plusGroup.length;

                writeGroup(otherGroup, 'FF000000'); // Black

                // ì¡°ê±´ë¶€ ì„œì‹ (Data Bar) - Bì—´
                if (minusGroup.length > 0) {
                    summarySheet.addConditionalFormatting({
                        ref: `B${minusStart}:B${minusEnd}`,
                        rules: [{
                            type: 'dataBar',
                            cfvo: [{ type: 'min', value: 0 }, { type: 'max' }],
                            color: { argb: 'FFFF6B6B' }, // Red Bar
                            showValue: true, gradient: true
                        }]
                    });
                }

                if (plusGroup.length > 0) {
                    summarySheet.addConditionalFormatting({
                        ref: `B${plusStart}:B${plusEnd}`,
                        rules: [{
                            type: 'dataBar',
                            cfvo: [{ type: 'min', value: 0 }, { type: 'max' }],
                            color: { argb: 'FF6BFF8E' }, // Green Bar
                            showValue: true, gradient: true
                        }]
                    });
                }

                // ì „ì²´ í…Œë‘ë¦¬
                summarySheet.eachRow((row) => {
                    row.eachCell((cell) => {
                        cell.border = {
                            top: {style:'thin', color: {argb:'FFCCCCCC'}},
                            left: {style:'thin', color: {argb:'FFCCCCCC'}},
                            bottom: {style:'thin', color: {argb:'FFCCCCCC'}},
                            right: {style:'thin', color: {argb:'FFCCCCCC'}}
                        };
                    });
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                saveAs(blob, 'ì†ì ˆìš”ì•½_ë‚ ì§œì •ë ¬.xlsx');
                
                alert('ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! (ì†ì ˆì¼ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬ ì™„ë£Œ)');

            } catch (err) {
                console.error(err);
                alert('ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            } finally {
                processBtn.disabled = false;
                btnText.textContent = "ìš”ì•½ íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ";
                loadingSpinner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
